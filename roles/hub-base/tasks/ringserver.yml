- name: create Ringserver directories
  file:
    path: "{{ ringserver_location }}/{{ item }}"
    state: directory
    owner: nrts
    group: nrts
    mode: 0775
  become: true
  loop: 
    - SeedLink
    - SeedLink/ring
    - SeedLink/bin
    - SeedLink/log

- name: install ring.conf
  template:
    src: ring.conf.j2
    dest: "{{ ringserver_location }}/SeedLink/ring.conf"
    owner: nrts
    group: nrts
    mode: 0644
  become: true

- name: make sure build dir exists
  file:
    path: "{{ ringserver_location }}/build"
    state: directory
    owner: nrts
    group: nrts
    mode: 0775
  become: true

- name: get source repositories
  get_url:
    url: {{ item }}
    dest: "{{ ringserver_location }}/build"
    owner: nrts
    group: nrts
    mode: 0664
  become: true
  loop:
    - "https://github.com/iris-edu/ringserver/archive/v2018.078.tar.gz"
    - "https://github.com/iris-edu/msi/archive/v3.8.tar.gz"
    - "https://github.com/iris-edu/slinktool/archive/v4.3.tar.gz"

- name: build msi v3.8
  shell: |
    cd "{{ ringserver_location }}/build"
    rm -rf msi-3.8
    tar xf msi-3.8.tar.gz
    cd msi-3.8
    make
  args:
    executable: /usr/bin/tcsh
  become: yes
  become_method: su
  become_user: nrts


- name: build ringserver v2018.078
  when: ringserver_on
  shell: |
    cd "{{ ringserver_location }}/build"
    rm -rf ringserver-2018.078
    tar xf ringserver-2018.078.tar.gz
    cd ringserver-2018.078
    make
  args:
    executable: /usr/bin/tcsh
  become: yes
  become_method: su
  become_user: nrts

- name: build slinktool v4.3 
  shell: |
    cd "{{ ringserver_location }}/build"
    rm -rf slinktool-4.3
    tar xf slinktool-4.3.tar.gz
    cd slinktool-4.3/libslink
    make
    cd ../ezxml
    setenv CFLAGS -std=c99
    make
    cd ..
    unsetenv CFLAGS
    make
  args:
    executable: /usr/bin/tcsh
  become: yes
  become_method: su
  become_user: nrts

- name: deploy seedlink and miniseed binaries to SeedLink/bin
  copy:
    src: "{{ ringserver_location }}/build/{{ item }}"
    dest: "{{ ringserver_location }}/SeedLink/bin/"
    owner: nrts
    group: nrts
    mode: 755
    remote_src: yes
  loop:
    - msi-3.8/msi
    - ringserver-2018.078/ringserver
    - slinktool-4.3/slinktool
  become: yes
  become_method: su
  become_user: nrts

